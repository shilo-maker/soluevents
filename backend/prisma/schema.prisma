// Prisma schema for SoluPlan — unified with SoluCast/SoluFlow shared database
//
// GROUP A: Introspected models (owned by Sequelize sync, read/write by Prisma)
//   - Use @map() for camelCase columns, @@map() for table names
//   - Prisma migrations NEVER touch these tables
//
// GROUP B: SoluPlan-owned models (managed by Prisma migrations)
//   - snake_case columns, standard Prisma conventions
//
// The User model is shared: Sequelize owns the original columns,
// Prisma migrations add SoluPlan-specific columns.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════
// ENUMS — SoluPlan-owned (Group B)
// ═══════════════════════════════════════════════════════════════════

enum OrgRole {
  admin
  manager
  member
  viewer
}

enum EventType {
  worship
  in_house
  film
  tour_child
}

enum EventPhase {
  concept
  prep
  execution
  follow_up
}

enum EventStatus {
  planned
  confirmed
  canceled
  archived
}

enum EventRole {
  event_manager
  worship_lead
  media_lead
  logistics
  hospitality
  comms
  contributor
  guest
}

enum TaskPriority {
  critical
  high
  normal
}

enum TaskStatus {
  not_started
  in_progress
  waiting
  blocked
  done
}

enum RoleScope {
  event
  tour
  tour_day
}

enum InvitationStatus {
  pending
  confirmed
  declined
}

enum EntityType {
  event
  task
  tour
  tour_day
}

enum TemplateKind {
  event
  tour
}

// ═══════════════════════════════════════════════════════════════════
// ENUMS — Introspected from SoluCast (Group A)
// ═══════════════════════════════════════════════════════════════════

enum SolucastUserRole {
  operator
  admin

  @@map("enum_users_role")
}

enum AuthProvider {
  local
  google

  @@map("enum_users_authProvider")
}

enum SongLanguage {
  he
  en
  es
  fr
  de
  ru
  ar
  other

  @@map("enum_songs_originalLanguage")
}

enum ApprovalStatus {
  pending
  approved
  rejected

  @@map("enum_songs_approvalStatus")
}

enum MediaType {
  image
  video

  @@map("enum_media_type")
}

enum BibleTestament {
  old
  new

  @@map("enum_bible_verses_testament")
}

enum WorkspaceType {
  personal
  organization

  @@map("enum_workspaces_workspaceType")
}

enum WorkspaceMemberRole {
  admin
  planner
  leader
  member

  @@map("enum_workspace_members_role")
}

enum FlowSegmentType {
  song
  prayer
  reading
  break_ @map("break")

  @@map("enum_flow_service_songs_segmentType")
}

enum DisplayType {
  viewer
  stage
  obs
  custom

  @@map("enum_remote_screens_displayType")
}

enum ReportStatus {
  pending
  reviewed
  resolved
  dismissed

  @@map("enum_song_reports_status")
}

// ═══════════════════════════════════════════════════════════════════
// SHARED MODEL — User (Sequelize creates base columns, Prisma adds SoluPlan columns)
// ═══════════════════════════════════════════════════════════════════

model User {
  id                       String           @id @default(uuid()) @db.Uuid
  email                    String           @unique @db.VarChar(255)
  password                 String?          @db.VarChar(255)
  authProvider             AuthProvider     @default(local) @map("authProvider")
  googleId                 String?          @map("googleId") @db.VarChar(255)
  solucastRole             SolucastUserRole @default(operator) @map("role")
  preferences              Json?            @default("{\"language\": \"he\"}")
  activeRoomId             String?          @map("activeRoomId") @db.Uuid
  isEmailVerified          Boolean?         @default(false) @map("isEmailVerified")
  emailVerificationToken   String?          @map("emailVerificationToken") @db.VarChar(255)
  emailVerificationExpires DateTime?        @map("emailVerificationExpires") @db.Timestamptz(6)
  passwordResetToken       String?          @map("passwordResetToken") @db.VarChar(255)
  passwordResetExpires     DateTime?        @map("passwordResetExpires") @db.Timestamptz(6)
  username                 String?          @db.VarChar(100)
  isActive                 Boolean?         @default(true) @map("isActive")
  activeWorkspaceId        String?          @map("activeWorkspaceId") @db.Uuid
  defaultWorkspaceId       String?          @map("defaultWorkspaceId") @db.Uuid
  soluflowLegacyId         Int?             @map("soluflowLegacyId")
  createdAt                DateTime         @default(now()) @map("createdAt") @db.Timestamptz(6)

  // --- SoluPlan-owned columns (snake_case, added by Prisma migration) ---
  name       String?
  name_he    String?           @map("name_he")
  name_en    String?           @map("name_en")
  org_role   OrgRole?
  avatar_url String?
  phone      String?

  // Email / SMTP settings (per-user)
  smtp_host     String?   @db.VarChar(255)
  smtp_port     Int?
  smtp_secure   Boolean   @default(false)
  smtp_user     String?   @db.VarChar(255)
  smtp_pass     String?   @db.VarChar(500)
  email_from    String?   @db.VarChar(255)

  // --- SoluPlan relations (Group B) ---
  created_events      Event[]           @relation("CreatedEvents")
  assigned_tasks      Task[]            @relation("AssignedTasks")
  created_tasks       Task[]            @relation("CreatedTasks")
  role_assignments    RoleAssignment[]
  comments            Comment[]
  uploaded_files      SoluplanFile[]
  notifications       Notification[]
  directed_tours      Tour[]            @relation("DirectorTours")
  logistics_tours     Tour[]            @relation("LogisticsTours")
  comms_tours         Tour[]            @relation("CommsTours")
  media_tours         Tour[]            @relation("MediaTours")
  hospitality_tours   Tour[]            @relation("HospitalityTours")
  devotional_tourdays TourDay[]
  created_contacts    Contact[]         @relation("CreatedContacts")
  created_venues      Venue[]           @relation("CreatedVenues")
  event_invitations   EventInvitation[] @relation("EventInvitations")
  memberInvitesReceived WorkspaceMemberInvite[] @relation("MemberInviteRecipient")
  memberInvitesSent     WorkspaceMemberInvite[] @relation("MemberInviteSender")
  pushSubscriptions     PushSubscription[]
  sentReminders         SentReminder[]

  // --- SoluCast relations (Group A) ---
  operatedRooms              Room[]
  createdSongs               Song[]              @relation("SongCreator")
  approvedSongs              Song[]              @relation("SongApprover")
  uploadedMedia              Media[]
  createdPresentations       Presentation[]
  createdViewerThemes        ViewerTheme[]
  createdStageThemes         StageMonitorTheme[]
  remoteScreens              RemoteScreen[]
  createdWorkspaces          Workspace[]         @relation("WorkspaceCreator")
  workspaceMemberships       WorkspaceMember[]
  ledFlowServices            FlowService[]       @relation("FlowServiceLeader")
  createdFlowServices        FlowService[]       @relation("FlowServiceCreator")
  createdFlowTags            FlowTag[]
  flowNotes                  FlowNote[]
  sharedSongsReceived        SharedSong[]        @relation("SharedSongRecipient")
  sharedSongsSent            SharedSong[]        @relation("SharedSongSender")
  sharedServicesReceived     SharedService[]
  publicRooms                PublicRoom[]
  songReportsReviewed        SongReport[]
  ssoCodes                   SSOCode[]
  createdWorkspaceInvitations WorkspaceInvitation[]

  @@index([activeRoomId], map: "users_active_room_id")
  @@index([email], map: "users_email")
  @@index([emailVerificationToken], map: "users_email_verification_token")
  @@index([passwordResetToken], map: "users_password_reset_token")
  @@map("users")
}

// ═══════════════════════════════════════════════════════════════════
// GROUP A — Introspected SoluCast Models (owned by Sequelize)
// ═══════════════════════════════════════════════════════════════════

model Song {
  id                String          @id @default(uuid()) @db.Uuid
  title             String          @db.VarChar(255)
  originalLanguage  SongLanguage?   @default(he) @map("originalLanguage")
  slides            Json            @default("[]")
  tags              Json?           @default("[]") @db.Json
  isPublic          Boolean?        @default(false) @map("isPublic")
  isPendingApproval Boolean?        @default(false) @map("isPendingApproval")
  createdById       String?         @map("createdById") @db.Uuid
  usageCount        Int?            @default(0) @map("usageCount")
  approvedById      String?         @map("approvedById") @db.Uuid
  approvedAt        DateTime?       @map("approvedAt") @db.Timestamptz(6)
  backgroundImage   String?         @default("") @map("backgroundImage") @db.VarChar(255)
  createdAt         DateTime        @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt         DateTime        @updatedAt @map("updatedAt") @db.Timestamptz(6)
  author            String?         @db.VarChar(255)
  chordProContent   String?         @map("chordProContent")
  musicalKey        String?         @map("musicalKey") @db.VarChar(10)
  bpm               Int?
  timeSignature     String?         @map("timeSignature") @db.VarChar(10)
  authors           String?         @db.VarChar(255)
  copyrightInfo     String?         @map("copyrightInfo")
  listenUrl         String?         @map("listenUrl") @db.VarChar(500)
  songCode          String?         @map("songCode") @db.VarChar(20)
  approvalStatus    ApprovalStatus? @map("approvalStatus")
  workspaceId       String?         @map("workspaceId") @db.Uuid
  soluflowLegacyId  Int?            @map("soluflowLegacyId")

  // Relations
  creator          User?            @relation("SongCreator", fields: [createdById], references: [id])
  approver         User?            @relation("SongApprover", fields: [approvedById], references: [id])
  workspace        Workspace?       @relation(fields: [workspaceId], references: [id])
  flowServiceSongs FlowServiceSong[]
  songTags         FlowSongTag[]
  sharedSongs      SharedSong[]
  songReports      SongReport[]
  flowNotes        FlowNote[]
  songWorkspaces   SongWorkspace[]

  @@index([createdById], map: "songs_created_by_id")
  @@index([isPendingApproval], map: "songs_is_pending_approval")
  @@index([isPublic, createdById], map: "songs_is_public_created_by_id")
  @@index([originalLanguage], map: "songs_original_language")
  @@index([soluflowLegacyId], map: "songs_soluflow_legacy_id")
  @@index([title], map: "songs_title")
  @@index([updatedAt], map: "songs_updated_at")
  @@index([usageCount], map: "songs_usage_count")
  @@index([workspaceId], map: "songs_workspace_id")
  @@map("songs")
}

model Room {
  id                       String       @id @default(uuid()) @db.Uuid
  pin                      String       @unique(map: "rooms_pin") @db.VarChar(4)
  operatorId               String       @map("operatorId") @db.Uuid
  isActive                 Boolean?     @default(true) @map("isActive")
  currentSlide             Json?        @default("{\"songId\": null, \"isBlank\": false, \"slideIndex\": 0, \"displayMode\": \"bilingual\"}") @map("currentSlide")
  currentImageUrl          String?      @map("currentImageUrl") @db.VarChar(255)
  currentBibleData         Json?        @map("currentBibleData")
  backgroundImage          String?      @default("") @map("backgroundImage") @db.VarChar(255)
  quickSlideText           String?      @default("") @map("quickSlideText") @db.VarChar(255)
  viewerCount              Int?         @default(0) @map("viewerCount")
  temporarySetlistId       String?      @map("temporarySetlistId") @db.Uuid
  linkedPermanentSetlistId String?      @map("linkedPermanentSetlistId") @db.Uuid
  lastActivity             DateTime?    @map("lastActivity") @db.Timestamptz(6)
  expiresAt                DateTime?    @map("expiresAt") @db.Timestamptz(6)
  createdAt                DateTime     @default(now()) @map("createdAt") @db.Timestamptz(6)
  activeThemeId            String?      @map("activeThemeId") @db.Uuid
  currentPresentationData  Json?        @map("currentPresentationData")

  // Relations
  operator         User         @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  temporarySetlist Setlist?     @relation("RoomTempSetlist", fields: [temporarySetlistId], references: [id])
  permanentSetlist Setlist?     @relation("RoomPermSetlist", fields: [linkedPermanentSetlistId], references: [id])
  activeTheme      ViewerTheme? @relation(fields: [activeThemeId], references: [id])
  publicRooms      PublicRoom[] @relation("PublicRoomActive")

  @@index([expiresAt], map: "rooms_expires_at")
  @@index([isActive], map: "rooms_is_active")
  @@index([lastActivity], map: "rooms_last_activity")
  @@index([operatorId], map: "rooms_operator_id")
  @@index([pin, isActive], map: "rooms_pin_is_active")
  @@map("rooms")
}

model Setlist {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(255)
  items         Json     @default("[]")
  createdById   String   @map("createdById") @db.Uuid
  isTemporary   Boolean? @default(false) @map("isTemporary")
  linkedRoomId  String?  @map("linkedRoomId") @db.Uuid
  usageCount    Int?     @default(0) @map("usageCount")
  shareToken    String?  @unique @map("shareToken") @db.VarChar(255)
  createdAt     DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updatedAt") @db.Timestamptz(6)
  flowServiceId String?  @unique @map("flowServiceId") @db.Uuid
  shareCode     String?  @unique @map("shareCode") @db.VarChar(20)

  // Relations
  roomsAsTemp Room[]       @relation("RoomTempSetlist")
  roomsAsPerm Room[]       @relation("RoomPermSetlist")
  flowService FlowService? @relation(fields: [flowServiceId], references: [id])

  @@index([createdById], map: "setlists_created_by_id")
  @@index([isTemporary], map: "setlists_is_temporary")
  @@index([isTemporary, createdAt], map: "setlists_is_temporary_created_at")
  @@index([linkedRoomId], map: "setlists_linked_room_id")
  @@index([shareCode], map: "setlists_share_code")
  @@index([updatedAt], map: "setlists_updated_at")
  @@map("setlists")
}

model Media {
  id           String    @id @default(uuid()) @db.Uuid
  name         String    @db.VarChar(255)
  type         MediaType
  url          String    @db.VarChar(255)
  thumbnailUrl String?   @default("") @map("thumbnailUrl") @db.VarChar(255)
  isPublic     Boolean?  @default(false) @map("isPublic")
  uploadedById String    @map("uploadedById") @db.Uuid
  createdAt    DateTime  @default(now()) @map("createdAt") @db.Timestamptz(6)
  fileSize     Int?      @map("fileSize")

  // Relations
  uploader User @relation(fields: [uploadedById], references: [id])

  @@index([isPublic, uploadedById], map: "media_is_public_uploaded_by_id")
  @@index([name], map: "media_name")
  @@index([uploadedById], map: "media_uploaded_by_id")
  @@map("media")
}

model BibleVerse {
  id          String         @id @default(uuid()) @db.Uuid
  book        String         @db.VarChar(255)
  bookNumber  Int            @map("bookNumber")
  testament   BibleTestament
  chapter     Int
  verse       Int
  hebrewText  String?        @default("") @map("hebrewText")
  englishText String?        @default("") @map("englishText")
  reference   String         @db.VarChar(255)
  createdAt   DateTime       @map("createdAt") @db.Timestamptz(6)
  updatedAt   DateTime       @updatedAt @map("updatedAt") @db.Timestamptz(6)

  @@index([book], map: "bible_verses_book")
  @@index([book, chapter, verse], map: "bible_verses_book_chapter_verse")
  @@index([chapter], map: "bible_verses_chapter")
  @@index([reference], map: "bible_verses_reference")
  @@index([testament], map: "bible_verses_testament")
  @@index([testament, bookNumber, chapter, verse], map: "bible_verses_testament_book_number_chapter_verse")
  @@map("bible_verses")
}

model Presentation {
  id                 String   @id @default(uuid()) @db.Uuid
  title              String   @db.VarChar(255)
  slides             Json     @default("[]")
  createdById        String?  @map("createdById") @db.Uuid
  isPublic           Boolean? @default(false) @map("isPublic")
  canvasDimensions   Json     @default("{\"width\": 1920, \"height\": 1080}") @map("canvasDimensions")
  backgroundSettings Json     @default("{\"type\": \"color\", \"value\": \"#000000\"}") @map("backgroundSettings")
  usageCount         Int?     @default(0) @map("usageCount")
  createdAt          DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updatedAt") @db.Timestamptz(6)
  quickModeData      Json?    @map("quickModeData")

  // Relations
  creator User? @relation(fields: [createdById], references: [id])

  @@index([createdById], map: "presentations_created_by_id")
  @@index([isPublic, createdById], map: "presentations_is_public_created_by_id")
  @@index([title], map: "presentations_title")
  @@index([updatedAt], map: "presentations_updated_at")
  @@map("presentations")
}

model ViewerTheme {
  id               String   @id @default(uuid()) @db.Uuid
  name             String   @db.VarChar(255)
  createdById      String?  @map("createdById") @db.Uuid
  isBuiltIn        Boolean? @default(false) @map("isBuiltIn")
  lineOrder        Json?    @default("[\"original\",\"transliteration\",\"translation\"]") @db.Json
  lineStyles       Json?    @default("{\"original\":{\"fontSize\":100,\"fontWeight\":\"500\",\"color\":\"#FFFFFF\",\"opacity\":1,\"visible\":true},\"transliteration\":{\"fontSize\":90,\"fontWeight\":\"400\",\"color\":\"#FFFFFF\",\"opacity\":0.95,\"visible\":true},\"translation\":{\"fontSize\":90,\"fontWeight\":\"400\",\"color\":\"#FFFFFF\",\"opacity\":0.95,\"visible\":true}}") @db.Json
  positioning      Json?    @default("{\"vertical\":\"center\",\"horizontal\":\"center\",\"customTop\":null,\"customLeft\":null}") @db.Json
  container        Json?    @default("{\"maxWidth\":\"100%\",\"padding\":\"2vh 6vw\",\"backgroundColor\":\"transparent\",\"borderRadius\":\"0px\"}") @db.Json
  viewerBackground Json?    @default("{\"type\":\"inherit\",\"color\":null}") @db.Json
  createdAt        DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updatedAt") @db.Timestamptz(6)
  linePositions    Json?    @db.Json
  canvasDimensions Json?    @default("{\"width\":1920,\"height\":1080}") @map("canvasDimensions") @db.Json
  backgroundBoxes  Json?    @default("[]") @map("backgroundBoxes") @db.Json

  // Relations
  creator User?  @relation(fields: [createdById], references: [id])
  rooms   Room[]

  @@index([createdById], map: "viewer_themes_created_by_id")
  @@index([isBuiltIn], map: "viewer_themes_is_built_in")
  @@index([name], map: "viewer_themes_name")
  @@map("viewer_themes")
}

model StageMonitorTheme {
  id               String   @id @default(uuid()) @db.Uuid
  name             String   @db.VarChar(255)
  createdById      String?  @map("createdById") @db.Uuid
  isBuiltIn        Boolean? @default(false) @map("isBuiltIn")
  canvasDimensions Json?    @default("{\"width\":1920,\"height\":1080}") @map("canvasDimensions") @db.Json
  colors           Json?    @default("{\"background\":\"#0a0a0a\",\"text\":\"#ffffff\",\"accent\":\"#4a90d9\",\"secondary\":\"#888888\",\"border\":\"#333333\"}") @db.Json
  header           Json?    @default("{\"visible\":true,\"x\":0,\"y\":0,\"width\":100,\"height\":8,\"backgroundColor\":\"transparent\",\"borderWidth\":1,\"borderColor\":\"#333333\"}") @db.Json
  clock            Json?    @default("{\"visible\":true,\"x\":85,\"y\":1,\"width\":13,\"height\":6,\"fontSize\":100,\"fontWeight\":\"bold\",\"color\":\"#ffffff\",\"fontFamily\":\"monospace\"}") @db.Json
  songTitle        Json?    @default("{\"visible\":true,\"x\":2,\"y\":1,\"width\":60,\"height\":6,\"fontSize\":100,\"fontWeight\":\"600\",\"color\":\"#4a90d9\"}") @map("songTitle") @db.Json
  currentSlideArea Json?    @default("{\"x\":2,\"y\":12,\"width\":64,\"height\":84,\"backgroundColor\":\"rgba(255,255,255,0.03)\",\"borderRadius\":12,\"borderWidth\":1,\"borderColor\":\"#333333\",\"padding\":2}") @db.Json
  currentSlideText Json?    @default("{\"original\":{\"visible\":true,\"fontSize\":100,\"fontWeight\":\"bold\",\"color\":\"#ffffff\",\"opacity\":1},\"transliteration\":{\"visible\":true,\"fontSize\":80,\"fontWeight\":\"400\",\"color\":\"#888888\",\"opacity\":1},\"translation\":{\"visible\":true,\"fontSize\":80,\"fontWeight\":\"400\",\"color\":\"#ffffff\",\"opacity\":0.9}}") @db.Json
  nextSlideArea    Json?    @default("{\"visible\":true,\"x\":68,\"y\":12,\"width\":30,\"height\":84,\"backgroundColor\":\"#1a1a1a\",\"borderRadius\":8,\"borderWidth\":1,\"borderColor\":\"#333333\",\"opacity\":0.8,\"labelText\":\"Next\",\"labelColor\":\"#888888\",\"labelFontSize\":90}") @db.Json
  backgroundBoxes  Json?    @default("[]") @map("backgroundBoxes") @db.Json
  createdAt        DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  creator User? @relation(fields: [createdById], references: [id])

  @@index([createdById], map: "stage_monitor_themes_created_by_id")
  @@index([isBuiltIn], map: "stage_monitor_themes_is_built_in")
  @@index([name], map: "stage_monitor_themes_name")
  @@map("stage_monitor_themes")
}

model RemoteScreen {
  id          String      @id @default(uuid()) @db.Uuid
  name        String      @db.VarChar(255)
  userId      String      @map("userId") @db.Uuid
  displayType DisplayType @default(viewer) @map("displayType")
  config      Json?       @default("{}") @db.Json
  createdAt   DateTime    @map("createdAt") @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId], map: "remote_screens_user_id")
  @@map("remote_screens")
}

model PublicRoom {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @db.VarChar(255)
  slug         String   @unique(map: "public_rooms_slug") @db.VarChar(255)
  ownerId      String   @map("ownerId") @db.Uuid
  activeRoomId String?  @map("activeRoomId") @db.Uuid
  createdAt    DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  owner      User  @relation(fields: [ownerId], references: [id])
  activeRoom Room? @relation("PublicRoomActive", fields: [activeRoomId], references: [id], map: "public_rooms_activeRoomId_fkey")

  @@index([activeRoomId], map: "public_rooms_active_room_id")
  @@index([ownerId], map: "public_rooms_owner_id")
  @@map("public_rooms")
}

model SongMapping {
  id                 String   @id @default(uuid()) @db.Uuid
  soluflowId         Int      @unique @map("soluflowId")
  soluflowTitle      String   @map("soluflowTitle") @db.VarChar(255)
  solupresenterId    String?  @map("solupresenterId") @db.Uuid
  solupresenterTitle String?  @map("solupresenterTitle") @db.VarChar(255)
  confidence         Int?
  manuallyLinked     Boolean? @default(false) @map("manuallyLinked")
  noMatch            Boolean? @default(false) @map("noMatch")
  createdAt          DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updatedAt") @db.Timestamptz(6)

  @@index([noMatch], map: "song_mappings_no_match")
  @@index([solupresenterId], map: "song_mappings_solupresenter_id")
  @@map("song_mappings")
}

// Legacy SongMappings table (PascalCase, created by earlier Sequelize version)
model SongMappingsLegacy {
  id                 Int      @id @default(autoincrement())
  soluflowId         Int      @unique
  soluflowTitle      String   @db.VarChar(255)
  solupresenterId    String?  @db.Uuid
  solupresenterTitle String?  @db.VarChar(255)
  confidence         Float?
  manuallyLinked     Boolean? @default(false)
  noMatch            Boolean? @default(false)
  createdAt          DateTime @db.Timestamptz(6)
  updatedAt          DateTime @db.Timestamptz(6)

  @@map("SongMappings")
}

// --- SoluFlow integration models ---

model Workspace {
  id            String        @id @default(uuid()) @db.Uuid
  name          String        @db.VarChar(255)
  slug          String        @unique(map: "workspaces_slug") @db.VarChar(255)
  workspaceType WorkspaceType @default(personal) @map("workspaceType")
  createdById   String        @map("createdById") @db.Uuid
  createdAt     DateTime      @map("createdAt") @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  creator        User                @relation("WorkspaceCreator", fields: [createdById], references: [id])
  members        WorkspaceMember[]
  songs          Song[]
  flowServices   FlowService[]
  invitations    WorkspaceInvitation[]
  memberInvites  WorkspaceMemberInvite[]
  songWorkspaces SongWorkspace[]

  @@index([createdById], map: "workspaces_created_by_id")
  @@index([workspaceType], map: "workspaces_workspace_type")
  @@map("workspaces")
}

model WorkspaceMember {
  id          String              @id @default(uuid()) @db.Uuid
  workspaceId String              @map("workspaceId") @db.Uuid
  userId      String              @map("userId") @db.Uuid
  role        WorkspaceMemberRole @default(member)
  joinedAt    DateTime?           @map("joinedAt") @db.Timestamptz(6)

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([workspaceId, userId], map: "workspace_members_workspace_id_user_id")
  @@index([userId], map: "workspace_members_user_id")
  @@index([workspaceId], map: "workspace_members_workspace_id")
  @@index([workspaceId, role])
  @@map("workspace_members")
}

model FlowService {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @map("workspaceId") @db.Uuid
  title       String    @db.VarChar(255)
  date        DateTime? @db.Date
  time        String?   @db.VarChar(10)
  location    String?   @db.VarChar(255)
  leaderId    String?   @map("leaderId") @db.Uuid
  createdById String    @map("createdById") @db.Uuid
  code        String?   @unique(map: "flow_services_code") @db.VarChar(8)
  isPublic    Boolean?  @default(false) @map("isPublic")
  isArchived  Boolean?  @default(false) @map("isArchived")
  createdAt   DateTime  @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  workspace      Workspace?      @relation(fields: [workspaceId], references: [id])
  leader         User?           @relation("FlowServiceLeader", fields: [leaderId], references: [id])
  creator        User?           @relation("FlowServiceCreator", fields: [createdById], references: [id])
  songs          FlowServiceSong[]
  setlist        Setlist?
  sharedServices SharedService[]
  flowNotes      FlowNote[]

  @@index([createdById], map: "flow_services_created_by_id")
  @@index([date], map: "flow_services_date")
  @@index([isArchived], map: "flow_services_is_archived")
  @@index([leaderId], map: "flow_services_leader_id")
  @@index([workspaceId], map: "flow_services_workspace_id")
  @@map("flow_services")
}

model FlowServiceSong {
  id             String          @id @default(uuid()) @db.Uuid
  serviceId      String          @map("serviceId") @db.Uuid
  songId         String?         @map("songId") @db.Uuid
  position       Int             @default(0)
  segmentType    FlowSegmentType @default(song) @map("segmentType")
  segmentTitle   String?         @map("segmentTitle") @db.VarChar(255)
  segmentContent String?         @map("segmentContent")
  notes          String?
  transposition  Int?            @default(0)
  createdAt      DateTime        @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt      DateTime        @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  service FlowService @relation(fields: [serviceId], references: [id])
  song    Song?       @relation(fields: [songId], references: [id])

  @@index([serviceId], map: "flow_service_songs_service_id")
  @@index([serviceId, position], map: "flow_service_songs_service_id_position")
  @@index([songId], map: "flow_service_songs_song_id")
  @@map("flow_service_songs")
}

model FlowTag {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  color       String?  @db.VarChar(20)
  isPublic    Boolean? @default(false) @map("isPublic")
  createdById String?  @map("createdById") @db.Uuid
  createdAt   DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  creator  User?         @relation(fields: [createdById], references: [id])
  songTags FlowSongTag[]

  @@index([createdById], map: "flow_tags_created_by_id")
  @@index([isPublic], map: "flow_tags_is_public")
  @@index([name], map: "flow_tags_name")
  @@map("flow_tags")
}

model FlowSongTag {
  id     String @id @default(uuid()) @db.Uuid
  songId String @map("songId") @db.Uuid
  tagId  String @map("tagId") @db.Uuid

  // Relations
  song Song    @relation(fields: [songId], references: [id])
  tag  FlowTag @relation(fields: [tagId], references: [id])

  @@unique([songId, tagId])
  @@unique([songId, tagId], map: "flow_song_tags_song_id_tag_id")
  @@index([songId], map: "flow_song_tags_song_id")
  @@index([tagId], map: "flow_song_tags_tag_id")
  @@map("flow_song_tags")
}

model FlowNote {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("userId") @db.Uuid
  songId    String   @map("songId") @db.Uuid
  serviceId String?  @map("serviceId") @db.Uuid
  content   Json?    @default("{}") @db.Json
  isVisible Boolean? @default(true) @map("isVisible")
  createdAt DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  user    User         @relation(fields: [userId], references: [id])
  song    Song         @relation(fields: [songId], references: [id])
  service FlowService? @relation(fields: [serviceId], references: [id])

  @@index([serviceId], map: "flow_notes_service_id")
  @@index([songId], map: "flow_notes_song_id")
  @@index([userId], map: "flow_notes_user_id")
  @@map("flow_notes")
}

model SharedSong {
  id         String    @id @default(uuid()) @db.Uuid
  songId     String    @map("songId") @db.Uuid
  userId     String    @map("userId") @db.Uuid
  sharedById String?   @map("sharedById") @db.Uuid
  sharedAt   DateTime? @map("sharedAt") @db.Timestamptz(6)

  // Relations
  song     Song  @relation(fields: [songId], references: [id])
  user     User  @relation("SharedSongRecipient", fields: [userId], references: [id])
  sharedBy User? @relation("SharedSongSender", fields: [sharedById], references: [id])

  @@unique([songId, userId], map: "shared_songs_song_id_user_id")
  @@index([sharedById], map: "shared_songs_shared_by_id")
  @@index([songId], map: "shared_songs_song_id")
  @@index([userId], map: "shared_songs_user_id")
  @@map("shared_songs")
}

model SharedService {
  id        String    @id @default(uuid()) @db.Uuid
  serviceId String    @map("serviceId") @db.Uuid
  userId    String    @map("userId") @db.Uuid
  sharedAt  DateTime? @map("sharedAt") @db.Timestamptz(6)

  // Relations
  service FlowService @relation(fields: [serviceId], references: [id])
  user    User        @relation(fields: [userId], references: [id])

  @@unique([serviceId, userId], map: "shared_services_service_id_user_id")
  @@index([serviceId], map: "shared_services_service_id")
  @@index([userId], map: "shared_services_user_id")
  @@map("shared_services")
}

model SongWorkspace {
  id          String @id @default(uuid()) @db.Uuid
  songId      String @map("songId") @db.Uuid
  workspaceId String @map("workspaceId") @db.Uuid

  // Relations
  song      Song      @relation(fields: [songId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([songId, workspaceId])
  @@unique([songId, workspaceId], map: "song_workspaces_song_id_workspace_id")
  @@index([songId], map: "song_workspaces_song_id")
  @@index([workspaceId], map: "song_workspaces_workspace_id")
  @@map("song_workspaces")
}

model SongReport {
  id            String       @id @default(uuid()) @db.Uuid
  songId        String       @map("songId") @db.Uuid
  reporterEmail String       @map("reporterEmail") @db.VarChar(255)
  reportType    String       @map("reportType") @db.VarChar(50)
  description   String?
  status        ReportStatus @default(pending)
  adminNotes    String?      @map("adminNotes")
  reviewedById  String?      @map("reviewedById") @db.Uuid
  createdAt     DateTime     @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt     DateTime     @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  song     Song  @relation(fields: [songId], references: [id])
  reviewer User? @relation(fields: [reviewedById], references: [id])

  @@index([reporterEmail], map: "song_reports_reporter_email")
  @@index([reviewedById], map: "song_reports_reviewed_by_id")
  @@index([songId], map: "song_reports_song_id")
  @@index([status], map: "song_reports_status")
  @@map("song_reports")
}

model WorkspaceInvitation {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @map("workspaceId") @db.Uuid
  token       String    @unique(map: "workspace_invitations_token") @db.VarChar(255)
  createdById String    @map("createdById") @db.Uuid
  expiresAt   DateTime? @map("expiresAt") @db.Timestamptz(6)
  usageCount  Int?      @default(0) @map("usageCount")
  maxUses     Int?      @map("maxUses")
  createdAt   DateTime  @default(now()) @map("createdAt") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updatedAt") @db.Timestamptz(6)

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id])
  creator   User?     @relation(fields: [createdById], references: [id])

  @@index([createdById], map: "workspace_invitations_created_by_id")
  @@index([workspaceId], map: "workspace_invitations_workspace_id")
  @@map("workspace_invitations")
}

model SSOCode {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique(map: "sso_codes_code") @db.VarChar(64)
  userId    String   @map("userId") @db.Uuid
  expiresAt DateTime @map("expiresAt") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("createdAt") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([expiresAt], map: "sso_codes_expires_at")
  @@map("sso_codes")
}

// ═══════════════════════════════════════════════════════════════════
// GROUP B — SoluPlan-owned Models (managed by Prisma migrations)
// ═══════════════════════════════════════════════════════════════════

model Event {
  id              String      @id @default(uuid()) @db.Uuid
  type            EventType
  title           String
  description     String?
  date_start      DateTime
  date_end        DateTime
  timezone        String      @default("America/New_York")
  location_name   String?
  address         String?
  est_attendance  Int?
  phase           EventPhase  @default(concept)
  status          EventStatus @default(planned)
  venue_id        String?     @db.Uuid
  parent_tour_id  String?     @db.Uuid
  tags            String[]
  program_agenda  Json?
  rider_details   Json?
  event_teams     Json?
  created_by      String      @db.Uuid
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  // Cross-references to SoluCast/SoluFlow (soft FKs — no DB constraint)
  flow_service_id String?     @db.Uuid
  setlist_id      String?     @db.Uuid
  workspace_id    String?     @db.Uuid

  // Relations
  creator          User              @relation("CreatedEvents", fields: [created_by], references: [id])
  venue            Venue?            @relation(fields: [venue_id], references: [id], onDelete: SetNull)
  parent_tour      Tour?             @relation("TourEvents", fields: [parent_tour_id], references: [id])
  role_assignments RoleAssignment[]
  tasks            Task[]
  files            SoluplanFile[]
  linked_tour_days TourDay[]
  invitations      EventInvitation[]

  @@index([created_by])
  @@index([venue_id])
  @@index([parent_tour_id])
  @@index([status])
  @@index([date_start])
  @@index([workspace_id])
  @@index([workspace_id, status, date_start])
  @@index([workspace_id, created_by])
  @@map("events")
}

model Tour {
  id                  String   @id @default(uuid()) @db.Uuid
  title               String
  start_date          DateTime
  end_date            DateTime
  regions             String[]
  director_user_id    String?  @db.Uuid
  logistics_user_id   String?  @db.Uuid
  comms_user_id       String?  @db.Uuid
  media_user_id       String?  @db.Uuid
  hospitality_user_id String?  @db.Uuid
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  // Relations
  director         User?             @relation("DirectorTours", fields: [director_user_id], references: [id])
  logistics        User?             @relation("LogisticsTours", fields: [logistics_user_id], references: [id])
  comms            User?             @relation("CommsTours", fields: [comms_user_id], references: [id])
  media            User?             @relation("MediaTours", fields: [media_user_id], references: [id])
  hospitality      User?             @relation("HospitalityTours", fields: [hospitality_user_id], references: [id])
  child_events     Event[]           @relation("TourEvents")
  tour_days        TourDay[]
  role_assignments RoleAssignment[]
  tasks            Task[]
  files            SoluplanFile[]

  @@map("tours")
}

model TourDay {
  id                     String   @id @default(uuid()) @db.Uuid
  tour_id                String   @db.Uuid
  date                   DateTime
  city                   String?
  venue_name             String?
  wake_time              String?
  drive_start_time       String?
  drive_duration_minutes Int?
  lunch_time             String?
  event_start_time       String?
  lodging_name           String?
  lodging_arrival_time   String?
  devotional_user_id     String?  @db.Uuid
  is_laundry_day         Boolean  @default(false)
  is_shopping_day        Boolean  @default(false)
  linked_event_id        String?  @db.Uuid
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  // Relations
  tour         Tour   @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  devotional   User?  @relation(fields: [devotional_user_id], references: [id])
  linked_event Event? @relation(fields: [linked_event_id], references: [id])

  @@index([tour_id])
  @@index([linked_event_id])
  @@map("tour_days")
}

model RoleAssignment {
  id       String    @id @default(uuid()) @db.Uuid
  event_id String?   @db.Uuid
  tour_id  String?   @db.Uuid
  user_id  String    @db.Uuid
  role     EventRole
  scope    RoleScope @default(event)

  // Relations
  event Event? @relation(fields: [event_id], references: [id], onDelete: Cascade)
  tour  Tour?  @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  user  User   @relation(fields: [user_id], references: [id])

  @@unique([event_id, user_id, role])
  @@unique([tour_id, user_id, role])
  @@index([event_id])
  @@index([tour_id])
  @@index([user_id])
  @@map("role_assignments")
}

model Task {
  id             String       @id @default(uuid()) @db.Uuid
  title          String
  description    String?
  priority       TaskPriority @default(normal)
  status         TaskStatus   @default(not_started)
  due_at         DateTime?
  link           String?
  event_id       String?      @db.Uuid
  tour_id        String?      @db.Uuid
  assignee_id            String?      @db.Uuid
  assignee_contact_id    String?      @db.Uuid
  assignee_is_user       Boolean      @default(true)
  assignment_status      InvitationStatus?
  creator_id             String       @db.Uuid
  parent_task_id         String?      @db.Uuid
  created_at             DateTime     @default(now())
  updated_at             DateTime     @updatedAt

  // Relations
  event             Event?   @relation(fields: [event_id], references: [id], onDelete: Cascade)
  tour              Tour?    @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  assignee          User?    @relation("AssignedTasks", fields: [assignee_id], references: [id])
  assignee_contact  Contact? @relation("AssignedTasksContact", fields: [assignee_contact_id], references: [id])
  creator           User     @relation("CreatedTasks", fields: [creator_id], references: [id])
  parent_task       Task?    @relation("Subtasks", fields: [parent_task_id], references: [id])
  subtasks          Task[]   @relation("Subtasks")

  @@index([assignee_id])
  @@index([assignee_contact_id])
  @@index([creator_id])
  @@index([event_id])
  @@index([tour_id])
  @@index([status])
  @@index([due_at])
  @@index([event_id, status, due_at])
  @@index([assignee_id, status, due_at])
  @@map("tasks")
}

model Comment {
  id          String     @id @default(uuid()) @db.Uuid
  body        String
  author_id   String     @db.Uuid
  entity_type EntityType
  entity_id   String     @db.Uuid
  mentions    String[]
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  // Relations
  author User @relation(fields: [author_id], references: [id])

  @@index([entity_type, entity_id])
  @@index([author_id])
  @@map("comments")
}

// Renamed to SoluplanFile to avoid collision with built-in File
model SoluplanFile {
  id          String    @id @default(uuid()) @db.Uuid
  event_id    String?   @db.Uuid
  tour_id     String?   @db.Uuid
  uploader_id String    @db.Uuid
  filename    String
  url         String
  version     Int       @default(1)
  notes       String?
  file_type   String    @default("link")
  file_size   Int       @default(0)
  mime_type   String?
  category    String?
  expired_at  DateTime?
  created_at  DateTime  @default(now())

  // Relations
  event    Event? @relation(fields: [event_id], references: [id], onDelete: Cascade)
  tour     Tour?  @relation(fields: [tour_id], references: [id], onDelete: Cascade)
  uploader User   @relation(fields: [uploader_id], references: [id])

  @@index([event_id])
  @@index([uploader_id])
  @@map("files")
}

model Template {
  id             String       @id @default(uuid()) @db.Uuid
  kind           TemplateKind
  label          String
  default_fields Json
  default_tasks  Json
  default_agenda Json
  default_rider  Json
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt

  @@map("templates")
}

model Notification {
  id         String    @id @default(uuid()) @db.Uuid
  user_id    String    @db.Uuid
  type       String
  payload    Json
  read_at    DateTime?
  created_at DateTime  @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([read_at])
  @@index([user_id, read_at])
  @@map("notifications")
}

model Contact {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  nickname   String?
  email      String?
  phone      String?
  role       String?
  notes      String?
  created_by String   @db.Uuid
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  creator        User   @relation("CreatedContacts", fields: [created_by], references: [id])
  assigned_tasks Task[] @relation("AssignedTasksContact")

  @@index([created_by])
  @@map("contacts")
}

model EventInvitation {
  id            String           @id @default(uuid()) @db.Uuid
  event_id      String           @db.Uuid
  email         String           @db.VarChar(255)
  name          String           @db.VarChar(200)
  token         String           @unique @db.VarChar(48)
  status        InvitationStatus @default(pending)
  roles_summary Json
  user_id       String?          @db.Uuid
  contact_id    String?          @db.Uuid
  sent_at       DateTime         @default(now())
  responded_at  DateTime?
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  // Relations
  event Event @relation(fields: [event_id], references: [id], onDelete: Cascade)
  user  User? @relation("EventInvitations", fields: [user_id], references: [id], onDelete: SetNull)

  @@unique([event_id, email])
  @@index([event_id])
  @@index([token])
  @@map("event_invitations")
}

model Venue {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  address    String?
  created_by String   @db.Uuid
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  creator User    @relation("CreatedVenues", fields: [created_by], references: [id])
  events  Event[]

  @@index([created_by])
  @@index([name])
  @@map("venues")
}

model WorkspaceMemberInvite {
  id              String              @id @default(uuid()) @db.Uuid
  workspace_id    String              @db.Uuid
  invited_email   String              @db.VarChar(255)
  invited_user_id String?             @db.Uuid
  role            WorkspaceMemberRole @default(member)
  status          InvitationStatus    @default(pending)
  token           String              @unique @db.VarChar(128)
  invited_by_id   String              @db.Uuid
  expires_at      DateTime            @db.Timestamptz(6)
  created_at      DateTime            @default(now())
  responded_at    DateTime?

  // Relations
  workspace   Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  invitedUser User?     @relation("MemberInviteRecipient", fields: [invited_user_id], references: [id], onDelete: SetNull)
  invitedBy   User      @relation("MemberInviteSender", fields: [invited_by_id], references: [id])

  @@unique([workspace_id, invited_email])
  @@index([workspace_id])
  @@index([invited_by_id])
  @@index([token])
  @@map("workspace_member_invites")
}

model PushSubscription {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  endpoint   String   @unique
  p256dh     String
  auth       String
  created_at DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("push_subscriptions")
}

model SentReminder {
  id           String   @id @default(uuid()) @db.Uuid
  entity_type  String   @db.VarChar(10)
  entity_id    String   @db.Uuid
  user_id      String   @db.Uuid
  reminder_key String   @db.VarChar(20)
  sent_at      DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([entity_type, entity_id, user_id, reminder_key])
  @@index([sent_at])
  @@map("sent_reminders")
}
